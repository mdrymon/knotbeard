var PEG = require('pegjs')

// NOTE:  we don't read from the filesystem so that this module can run in the browser
// MAKE SURE THAT this variable matches the contents of id_grammar.pegjs!
var grammar = [
  "start",
  "  = waterfall*",
  "waterfall",
  "  = (node / leaf)",
  "  / wait",
  " ",
  "wait",
  " = '~' { return 'wait' }",
  " ",
  "leaf",
  "  = '<' id:id '>' { return {id: id} }",
  " ",
  "node",
  "  = '<' id:id inner:(node / leaf)+ id '>' { return {id: id, children: inner}}",
  " ",
  "id",
  "  = id:baseid visit* { return id }",
  " ",
  "visit",
  "  = '{' [0-9]+ '}'",
  " ",
  "baseid",
  "  = letters:([0-9] / [a-z])+ { return letters.join('');}"
].join('\n')

// var fs = require('fs')
// var path = require('path')
// var grammar = fs.readFileSync(path.join(__dirname, './id_grammar.pegjs')).toString()
var parser = PEG.buildParser(grammar)

module.exports.tree = function tree(id){
  return parser.parse(id)
}
