'use strict';

var test = require("tape")

var costTree = require("../lib/cost_tree")

var data = require('strong-trace-waterfalldata')

test("legacyExpress", function (t) {
  data.expressExample.waterfalls.forEach(function (wf) {
    var tree = costTree(wf, data.expressExample.functions)
    var syncCount = wf.id.split(/~/).length
    t.ok(tree.children.length <= syncCount, "No invented sync blocks")
    validate(tree, t)
  })
  t.end()
})

test("express", function (t) {
  data.express2.waterfalls.forEach(function (wf) {
    var tree = costTree(wf, data.express2.functions)
    validate(tree, t)
  })
  t.end()
})

function validate(tree, t) {
  var depth = 1
  var siblingCost = []

  tree.children.forEach(function (branch) {
    walk(branch)
  })

  function walk(branch) {
    t.equals(branch.depth, depth, "Depth is correct")
    t.ok(branch.cost >= branch.childCost, "cost >= childCost")
    t.ok(branch.name.length > 0, "has a name")
    t.ok(branch.visits >= 1, "visits is a positive value")
    t.ok(branch.uid, 'treeCost has a unique id')
    if (siblingCost.length) {
      t.ok(siblingCost[siblingCost.length - 1] >= branch.cost, "don't exceed sibling cost")
    }

    siblingCost.push(branch.cost)
    depth++
    branch.children.forEach(walk)
    depth--
    siblingCost.pop()
  }
}
