'use strict';

var test  = require('tape')
var data  = require('strong-trace-waterfalldata')
var xform = require('../index')
var _     = require('underscore')


test('basic sanity check of waterfalls added to transactions', function(t) {
  var copy = JSON.parse(JSON.stringify(data.expressExample))
  var waterfall = xform.enhanceWaterfall(copy)
  t.assert(waterfall, 'waterfall enhanced')
  t.assert(waterfall.transactions, 'transactions exist')
  t.assert(waterfall.transactions.transactions, 'transaction items exist')
  _.keys(waterfall.transactions.transactions).forEach(function(key){
    t.assert(waterfall.transactions.transactions[key].waterfalls.length >= 1, 'waterfalls added to transactions')
    waterfall.transactions.transactions[key].waterfalls.forEach(function(w){
      if( key != 'undefined' && key != 'untagged'){
        if( w.tags.indexOf(key) == -1){
          console.error('missing tag ', key, w.tags)
        }
        t.assert(w.tags.indexOf(key) != -1, 'tag exists in waterfall')
      } else {
        t.assert((!w.tags || w.tags.length === 0), 'no tags for undefined waterfalls' )
      }
    })
  })
  t.end()
})
